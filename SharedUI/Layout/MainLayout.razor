@inherits LayoutComponentBase
@implements IDisposable
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using SharedUI.Services.Settings

@inject AppSettingsService Settings
@inject NavigationManager Nav
@inject IJSRuntime JS

<CascadingValue Value="this" IsFixed="true">
    <MudThemeProvider IsDarkMode="_isDarkMode" />
    <MudPopoverProvider />
    <MudDialogProvider />
    <MudSnackbarProvider />

    <MudBreakpointProvider OnBreakpointChanged="OnBreakpointChanged" />

    <div tabindex="0" style="outline:none;" @onkeydown="OnKeyDown" @onkeydown:preventDefault="true">
    <MudLayout>
        <MudAppBar Dense="true">
            <MudText Typo="Typo.h6">MOGE</MudText>

            <MudSpacer />

            <MudTooltip Text="Settings">
                <MudIconButton Icon="@Icons.Material.Filled.Settings"
                               Color="Color.Inherit"
                               Edge="Edge.End"
                               OnClick="GoSettings"
                               aria-label="Open Settings" />
            </MudTooltip>

            <MudTooltip Text="Download Logs">
                <MudIconButton Icon="@Icons.Material.Filled.Download"
                               Color="Color.Inherit"
                               Edge="Edge.End"
                               OnClick="DownloadLogs"
                               aria-label="Download Logs" />
            </MudTooltip>

            <MudTooltip Text="Properties">
                <MudIconButton Icon="@Icons.Material.Filled.Tune"
                               Color="Color.Inherit"
                               Style="@ToggleIconStyle(RightOpen)"
                               Edge="Edge.End"
                               OnClick="ToggleRight"
                               aria-label="Toggle Properties" />
            </MudTooltip>
        </MudAppBar>

        <MudDrawer Anchor="Anchor.Right"
                   Elevation="1"
                   Variant="DrawerVariant.Temporary"
                   Open="@RightOpen"
                   OpenChanged="OnRightOpenChanged"
                   Width="@RightDrawerWidth"
                   Style="@RightDrawerStyle">
            <MudStack Spacing="2" Class="pa-3" Style="overflow:auto; max-height:100%;">
                <MudText Typo="Typo.subtitle1">Properties</MudText>
                @if (RightPanel is null)
                {
                    <MudText Typo="Typo.body2">Select a tool or filter to edit.</MudText>
                }
                else
                {
                    @RightPanel
                }
            </MudStack>
        </MudDrawer>

        <MudMainContent>
            <MudContainer MaxWidth="MaxWidth.False" Class="pa-0" Style="padding-bottom: 96px;">
                @Body
            </MudContainer>
        </MudMainContent>

        <MudPaper Square="true" Elevation="0" Class="px-3 py-2"
                  Style="position:fixed; left:0; right:0; bottom:0; border-top:1px solid var(--mud-palette-lines-default); z-index: 1200;">
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Spacing="0">
                    @foreach (var msg in VisibleFooterMessages)
                    {
                        <MudText Typo="Typo.caption">@msg</MudText>
                    }
                </MudStack>

                <MudStack Row="true" Spacing="0" AlignItems="AlignItems.Center">
                    <MudIconButton Icon="@Icons.Material.Filled.KeyboardArrowUp" Disabled="@(!CanScrollOlder)" OnClick="ScrollOlder" aria-label="Footer: Older messages" />
                    <MudIconButton Icon="@Icons.Material.Filled.KeyboardArrowDown" Disabled="@(!CanScrollNewer)" OnClick="ScrollNewer" aria-label="Footer: Newer messages" />
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudLayout>
    </div>
</CascadingValue>

@code {
    private bool _isMobile;
    private bool _rightOpen = true;

    private bool _isDarkMode;

    private bool _autoClosePropertiesOnMobileEnter = true;

    protected RenderFragment? RightPanel { get; set; }

    public event Func<Task>? UndoRequested;
    public event Func<Task>? RedoRequested;

    private const int FooterMaxMessages = 30;
    private const int FooterPageSize = 3;
    private readonly List<string> _footerMessages = new();
    private int _footerPageOffset;

    protected override async Task OnInitializedAsync()
    {
        await Settings.InitializeAsync();
        await ApplySettingsAsync(Settings.Current);
        Settings.Changed += OnSettingsChanged;
    }

    private void OnSettingsChanged(AppSettings s)
    {
        _ = InvokeAsync(() => ApplySettingsAsync(s));
    }

    private async Task ApplySettingsAsync(AppSettings s)
    {
        _autoClosePropertiesOnMobileEnter = s.AutoClosePropertiesOnMobileEnter;
        _rightOpen = s.PropertiesPanelDefaultOpen;

        if (s.ThemeMode == AppThemeMode.Light)
            _isDarkMode = false;
        else if (s.ThemeMode == AppThemeMode.Dark)
            _isDarkMode = true;
        else if (s.ThemeMode == AppThemeMode.System)
            _isDarkMode = await TryGetSystemPrefersDarkAsync(_isDarkMode);

        StateHasChanged();
    }

    private async Task<bool> TryGetSystemPrefersDarkAsync(bool fallback)
    {
        try
        {
            return await JS.InvokeAsync<bool>("mogeTheme.prefersDark");
        }
        catch
        {
            return fallback;
        }
    }

    public void SetRightPanel(RenderFragment? fragment)
    {
        RightPanel = fragment;
        StateHasChanged();
    }

    public void SetFooterMessage(string? message) => PushFooterMessage(message);

    public void PushFooterMessage(string? message)
    {
        if (string.IsNullOrWhiteSpace(message))
            return;

        // Avoid spamming identical consecutive messages.
        if (_footerMessages.Count > 0 && string.Equals(_footerMessages[^1], message, StringComparison.Ordinal))
            return;

        _footerMessages.Add(message);

        if (_footerMessages.Count > FooterMaxMessages)
            _footerMessages.RemoveRange(0, _footerMessages.Count - FooterMaxMessages);

        _footerPageOffset = 0;
        StateHasChanged();
    }

    private IEnumerable<string> VisibleFooterMessages
    {
        get
        {
            if (_footerMessages.Count == 0)
                return Array.Empty<string>();

            var endExclusive = Math.Max(0, _footerMessages.Count - (_footerPageOffset * FooterPageSize));
            var start = Math.Max(0, endExclusive - FooterPageSize);
            if (endExclusive <= start)
                return Array.Empty<string>();

            return _footerMessages.GetRange(start, endExclusive - start);
        }
    }

    private bool CanScrollOlder => _footerMessages.Count - ((_footerPageOffset + 1) * FooterPageSize) > 0;
    private bool CanScrollNewer => _footerPageOffset > 0;

    private void ScrollOlder()
    {
        if (!CanScrollOlder)
            return;

        _footerPageOffset++;
        StateHasChanged();
    }

    private void ScrollNewer()
    {
        if (!CanScrollNewer)
            return;

        _footerPageOffset--;
        StateHasChanged();
    }

    private void OnKeyDown(KeyboardEventArgs e)
    {
        if ((e.CtrlKey || e.MetaKey) && string.Equals(e.Key, "z", StringComparison.OrdinalIgnoreCase))
        {
            // Common editor shortcuts: Ctrl+Z = Undo, Ctrl+Shift+Z = Redo
            if (e.ShiftKey)
                _ = RedoRequested?.Invoke();
            else
                _ = UndoRequested?.Invoke();

            return;
        }

        if ((e.CtrlKey || e.MetaKey) && string.Equals(e.Key, "y", StringComparison.OrdinalIgnoreCase))
        {
            // Common Windows shortcut: Ctrl+Y = Redo
            _ = RedoRequested?.Invoke();
            return;
        }

        if (string.Equals(e.Key, "ArrowUp", StringComparison.OrdinalIgnoreCase))
        {
            ScrollOlder();
            return;
        }

        if (string.Equals(e.Key, "ArrowDown", StringComparison.OrdinalIgnoreCase))
        {
            ScrollNewer();
            return;
        }
    }

    private bool RightOpen => _rightOpen;

    private Task OnBreakpointChanged(Breakpoint breakpoint)
    {
        var isMobile = breakpoint < Breakpoint.Md;
        if (isMobile && !_isMobile)
        {
            if (_autoClosePropertiesOnMobileEnter)
                _rightOpen = false;
        }

        _isMobile = isMobile;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void ToggleRight() => _rightOpen = !_rightOpen;

    private Task OnRightOpenChanged(bool open)
    {
        _rightOpen = open;
        return Task.CompletedTask;
    }

    private string RightDrawerWidth => _isMobile ? "100%" : "360px";
    private string RightDrawerStyle
        => _isMobile
            ? "top:48px; height: calc(100vh - 48px - 96px);"
            : "top:48px; height: calc(100vh - 48px - 96px);";

    private void GoSettings() => Nav.NavigateTo("/settings");

    private async Task DownloadLogs()
    {
        try
        {
            await JS.InvokeVoidAsync("mogeBrowserLog.downloadToday");
        }
        catch
        {
            // Best-effort.
        }
    }

    private static string? ThemeIconStyle(bool isSelected)
    {
        if (!isSelected)
            return null;

        // AppBar 배경색과 상관없이 보이도록 currentColor(=아이콘/텍스트 색) 기반 강조
        return "border:1px solid currentColor; border-radius: var(--mud-default-borderradius);";
    }

    private static string? ToggleIconStyle(bool isSelected) => ThemeIconStyle(isSelected);

    public void Dispose()
    {
        Settings.Changed -= OnSettingsChanged;
    }
}
