@using MudBlazor
@using SharedUI.Services

<MudStack Spacing="2">
    <MudDivider />
    <MudText Typo="Typo.subtitle2">Layers</MudText>

    <MudStack Row="true" Spacing="1">
        <MudTooltip Text="Add Layer">
            <MudIconButton Icon="@Icons.Material.Filled.Add"
                           Disabled="@(!HasImage)"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await AddLayer.InvokeAsync())"
                           aria-label="Add Layer" />
        </MudTooltip>

        <MudTooltip Text="Duplicate Layer">
            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                           Disabled="@(!HasImage)"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await DuplicateLayer.InvokeAsync())"
                           aria-label="Duplicate Layer" />
        </MudTooltip>

        <MudTooltip Text="Merge Down">
            <MudIconButton Icon="@Icons.Material.Filled.MergeType"
                           Disabled="@(!HasImage || !CanMergeDown)"
                           Color="@((HasImage && CanMergeDown) ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage && CanMergeDown)"
                           OnClick="@(async () => await MergeDownLayer.InvokeAsync())"
                           aria-label="Merge Down" />
        </MudTooltip>

        <MudTooltip Text="Delete Layer">
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Disabled="@(!HasImage || !CanDeleteLayer)"
                           Color="@((HasImage && CanDeleteLayer) ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage && CanDeleteLayer)"
                           OnClick="@(async () => await DeleteLayer.InvokeAsync())"
                           aria-label="Delete Layer" />
        </MudTooltip>
    </MudStack>

    @if (Layers is { Count: > 0 })
    {
        <MudStack Spacing="1">
            @foreach (var layer in Layers)
            {
                var isActive = layer.Index == ActiveLayerIndex;
                var canSelect = HasImage && layer.Visible;

                <MudPaper Elevation="0" Class="pa-1" Style="@LayerItemStyle(isActive)">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <button type="button"
                                disabled="@(!HasImage || !CanToggleLayerVisibility)"
                                @onclick="(async () => await ToggleLayerVisibility.InvokeAsync(layer.Index))"
                                aria-label="Toggle Layer Visibility"
                                style="background:transparent; border:0; padding:4px; cursor:pointer;">
                            <MudIcon Icon="@(layer.Visible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)" Size="Size.Small" />
                        </button>

                        <div style="flex:1; display:flex; align-items:center; gap:4px; cursor:@(canSelect ? "pointer" : "not-allowed"); opacity:@(layer.Visible ? "1" : "0.5");"
                             @onclick="@(async () => { if (canSelect) await SelectLayerAsync(layer.Index); })">
                            @if (isActive)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" Size="Size.Small" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Inherit" Size="Size.Small" Style="opacity:0.25;" />
                            }

                            <MudText Typo="Typo.caption" Style="@(isActive ? "font-weight:600;" : null)">@layer.Name</MudText>
                        </div>
                     </MudStack>
                 </MudPaper>
            }
        </MudStack>
    }
    else
    {
        <MudText Typo="Typo.caption" Style="opacity:0.6;">No layers</MudText>
    }

    <MudDivider />

    <MudText Typo="Typo.subtitle2">Transform</MudText>
    <MudStack Row="true" Spacing="1">
        <MudTooltip Text="Rotate Left">
            <MudIconButton Icon="@Icons.Material.Filled.RotateLeft"
                           Disabled="@(!HasImage)"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await RotateLeft.InvokeAsync())"
                           aria-label="Rotate Left" />
        </MudTooltip>
        <MudTooltip Text="Rotate Right">
            <MudIconButton Icon="@Icons.Material.Filled.RotateRight"
                           Disabled="@(!HasImage)"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await RotateRight.InvokeAsync())"
                           aria-label="Rotate Right" />
        </MudTooltip>
    </MudStack>
    <MudTooltip Text="Resize 50%">
        <MudIconButton Icon="@Icons.Material.Filled.PhotoSizeSelectSmall"
                       Disabled="@(!HasImage)"
                       Color="@(HasImage ? Color.Primary : Color.Inherit)"
                       Style="@ActionIconStyle(HasImage)"
                       OnClick="@(async () => await ResizeHalf.InvokeAsync())"
                       aria-label="Resize 50%" />
    </MudTooltip>

    <MudDivider />
    <MudText Typo="Typo.subtitle2">Filters</MudText>

    <MudExpansionPanels Dense="true" MultiExpansion="true">
        <MudExpansionPanel Text="Basic" Expanded="true">
            <MudText Typo="Typo.caption">Blur Kernel</MudText>
            <MudSlider T="int" Value="@BlurKernelSize" ValueChanged="BlurKernelSizeChanged" Min="0" Max="31" Step="1" Color="Color.Primary" />

            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                <MudTooltip Text="Grayscale">
                    <MudIconButton Icon="@Icons.Material.Filled.MonochromePhotos"
                                   Color="@(Grayscale ? Color.Primary : Color.Inherit)"
                                   Disabled="@(Sepia || ColorMap != ColorMapStyle.None)"
                                   Style="@ToggleIconStyle(Grayscale && !Sepia && ColorMap == ColorMapStyle.None)"
                                   OnClick="ToggleGrayscale"
                                   aria-label="Toggle Grayscale" />
                </MudTooltip>
                <MudTooltip Text="Canny Edge">
                    <MudIconButton Icon="@Icons.Material.Filled.Timeline"
                                   Color="@(Canny ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(Canny)"
                                   OnClick="ToggleCanny"
                                   aria-label="Toggle Canny Edge" />
                </MudTooltip>
            </MudStack>

            @if (Canny)
            {
                <MudText Typo="Typo.caption">Canny T1</MudText>
                <MudSlider T="double" Value="@CannyT1" ValueChanged="CannyT1Changed" Min="0" Max="255" Step="1" Color="Color.Primary" />
                <MudText Typo="Typo.caption">Canny T2</MudText>
                <MudSlider T="double" Value="@CannyT2" ValueChanged="CannyT2Changed" Min="0" Max="255" Step="1" Color="Color.Primary" />
            }

            <MudText Typo="Typo.caption">Contrast</MudText>
            <MudSlider T="double" Value="@Contrast" ValueChanged="ContrastChanged" Min="0.5" Max="3.0" Step="0.05" Color="Color.Primary" />

            <MudText Typo="Typo.caption">Brightness</MudText>
            <MudSlider T="double" Value="@Brightness" ValueChanged="BrightnessChanged" Min="-100" Max="100" Step="1" Color="Color.Primary" />

            <MudText Typo="Typo.caption">Saturation</MudText>
            <MudSlider T="double" Value="@Saturation" ValueChanged="SaturationChanged" Min="0" Max="3.0" Step="0.05" Color="Color.Primary" />
        </MudExpansionPanel>

        <MudExpansionPanel Text="Styles">
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                <MudTooltip Text="Sketch">
                    <MudIconButton Icon="@Icons.Material.Filled.Draw"
                                   Color="@(Sketch ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(Sketch)"
                                   OnClick="ToggleSketch"
                                   aria-label="Toggle Sketch" />
                </MudTooltip>
                <MudTooltip Text="Cartoon">
                    <MudIconButton Icon="@Icons.Material.Filled.Face"
                                   Color="@(Cartoon ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(Cartoon)"
                                   OnClick="ToggleCartoon"
                                   aria-label="Toggle Cartoon" />
                </MudTooltip>
                <MudTooltip Text="Emboss">
                    <MudIconButton Icon="@Icons.Material.Filled.Texture"
                                   Color="@(Emboss ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(Emboss)"
                                   OnClick="ToggleEmboss"
                                   aria-label="Toggle Emboss" />
                </MudTooltip>
            </MudStack>

            <MudText Typo="Typo.caption">Sharpen</MudText>
            <MudSlider T="double" Value="@FilterSharpenAmount" ValueChanged="FilterSharpenAmountChanged" Min="0" Max="3.0" Step="0.05" Color="Color.Primary" />

            <MudText Typo="Typo.caption">Glow</MudText>
            <MudSlider T="double" Value="@GlowStrength" ValueChanged="GlowStrengthChanged" Min="0" Max="1.0" Step="0.02" Color="Color.Primary" />
        </MudExpansionPanel>

        <MudExpansionPanel Text="Mood">
            <MudText Typo="Typo.caption">Color Map Style</MudText>
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="flex-wrap">
                <MudTooltip Text="None">
                    <MudIconButton Icon="@Icons.Material.Filled.DoNotDisturb"
                                   Color="@(ColorMap == ColorMapStyle.None ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.None)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.None))"
                                   aria-label="No Color Map" />
                </MudTooltip>
                <MudTooltip Text="Sepia">
                    <MudIconButton Icon="@Icons.Material.Filled.FilterVintage"
                                   Color="@(Sepia ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(Sepia)"
                                   OnClick="ToggleSepia"
                                   aria-label="Toggle Sepia" />
                </MudTooltip>
                <MudTooltip Text="Autumn">
                    <MudIconButton Icon="@Icons.Material.Filled.Park"
                                   Color="@(ColorMap == ColorMapStyle.Autumn ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Autumn)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Autumn))"
                                   aria-label="Autumn Color Map" />
                </MudTooltip>
                <MudTooltip Text="Ocean">
                    <MudIconButton Icon="@Icons.Material.Filled.Water"
                                   Color="@(ColorMap == ColorMapStyle.Ocean ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Ocean)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Ocean))"
                                   aria-label="Ocean Color Map" />
                </MudTooltip>
                <MudTooltip Text="Summer">
                    <MudIconButton Icon="@Icons.Material.Filled.WbSunny"
                                   Color="@(ColorMap == ColorMapStyle.Summer ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Summer)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Summer))"
                                   aria-label="Summer Color Map" />
                </MudTooltip>
                <MudTooltip Text="Winter">
                    <MudIconButton Icon="@Icons.Material.Filled.AcUnit"
                                   Color="@(ColorMap == ColorMapStyle.Winter ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Winter)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Winter))"
                                   aria-label="Winter Color Map" />
                </MudTooltip>
                <MudTooltip Text="Hot">
                    <MudIconButton Icon="@Icons.Material.Filled.Whatshot"
                                   Color="@(ColorMap == ColorMapStyle.Hot ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Hot)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Hot))"
                                   aria-label="Hot Color Map" />
                </MudTooltip>
                <MudTooltip Text="Jet">
                    <MudIconButton Icon="@Icons.Material.Filled.LocalFireDepartment"
                                   Color="@(ColorMap == ColorMapStyle.Jet ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Jet)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Jet))"
                                   aria-label="Jet Color Map" />
                </MudTooltip>
                <MudTooltip Text="Rainbow">
                    <MudIconButton Icon="@Icons.Material.Filled.FilterDrama"
                                   Color="@(ColorMap == ColorMapStyle.Rainbow ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Rainbow)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Rainbow))"
                                   aria-label="Rainbow Color Map" />
                </MudTooltip>
                <MudTooltip Text="Pink">
                    <MudIconButton Icon="@Icons.Material.Filled.Favorite"
                                   Color="@(ColorMap == ColorMapStyle.Pink ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(ColorMap == ColorMapStyle.Pink)"
                                   OnClick="@(() => ColorMapChanged.InvokeAsync(ColorMapStyle.Pink))"
                                   aria-label="Pink Color Map" />
                </MudTooltip>
            </MudStack>

            @if (ColorMap != ColorMapStyle.None)
            {
                <MudText Typo="Typo.caption">Color Map Strength</MudText>
                <MudSlider T="double" Value="@ColorMapStrength" ValueChanged="ColorMapStrengthChanged" Min="0" Max="1.0" Step="0.02" Color="Color.Primary" />
            }
        </MudExpansionPanel>

        <MudExpansionPanel Text="Retro">
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                <MudTooltip Text="Invert">
                    <MudIconButton Icon="@Icons.Material.Filled.InvertColors"
                                   Color="@(Invert ? Color.Primary : Color.Inherit)"
                                   Style="@ToggleIconStyle(Invert)"
                                   OnClick="ToggleInvert"
                                   aria-label="Toggle Invert" />
                </MudTooltip>
            </MudStack>

            <MudText Typo="Typo.caption">Posterize Levels</MudText>
            <MudSlider T="int" Value="@PosterizeLevels" ValueChanged="PosterizeLevelsChanged" Min="0" Max="32" Step="1" Color="Color.Primary" />

            <MudText Typo="Typo.caption">Pixelize Block Size</MudText>
            <MudSlider T="int" Value="@PixelizeBlockSize" ValueChanged="PixelizeBlockSizeChanged" Min="0" Max="64" Step="1" Color="Color.Primary" />

            <MudText Typo="Typo.caption">Vignette</MudText>
            <MudSlider T="double" Value="@VignetteStrength" ValueChanged="VignetteStrengthChanged" Min="0" Max="1.0" Step="0.02" Color="Color.Primary" />

            <MudText Typo="Typo.caption">Noise</MudText>
            <MudSlider T="double" Value="@NoiseAmount" ValueChanged="NoiseAmountChanged" Min="0" Max="1.0" Step="0.02" Color="Color.Primary" />
        </MudExpansionPanel>
    </MudExpansionPanels>

    <MudDivider />
    <MudText Typo="Typo.subtitle2">History</MudText>
    <MudStack Row="true" Spacing="1">
        <MudTooltip Text="Undo">
            <MudIconButton Icon="@Icons.Material.Filled.Undo"
                           Disabled="@(!CanUndo)"
                           OnClick="@(async () => await Undo.InvokeAsync())"
                           aria-label="Undo" />
        </MudTooltip>
        <MudTooltip Text="Redo">
            <MudIconButton Icon="@Icons.Material.Filled.Redo"
                           Disabled="@(!CanRedo)"
                           OnClick="@(async () => await Redo.InvokeAsync())"
                           aria-label="Redo" />
        </MudTooltip>
        <MudTooltip Text="Reset">
            <MudIconButton Icon="@Icons.Material.Filled.Restore"
                           Disabled="@(!CanUndo)"
                           OnClick="@(async () => await Reset.InvokeAsync())"
                           aria-label="Reset" />
        </MudTooltip>
    </MudStack>

    <MudList T="string" Dense="true">
        @if (HistoryItems is not null)
        {
            @foreach (var item in HistoryItems)
            {
                var idx = item.Index;
                var isCurrent = idx == CurrentHistoryIndex;
                <MudListItem T="string" Value="@item.DisplayLabel" OnClick="@(async () => await OnHistoryItemClicked(idx))" Disabled="@(!HasImage)" Style="@HistoryItemStyle(isCurrent)">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        @if (isCurrent)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" Size="Size.Small" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Inherit" Size="Size.Small" Style="opacity:0.25;" />
                        }

                        @if (!string.IsNullOrWhiteSpace(item.ThumbnailDataUrl))
                        {
                            <img src="@item.ThumbnailDataUrl" width="40" height="40" style="object-fit:contain" />
                        }
                        <MudText Typo="Typo.caption" Style="@(isCurrent ? "font-weight:600;" : null)">@item.DisplayLabel</MudText>
                    </MudStack>
                </MudListItem>
            }
        }
    </MudList>

</MudStack>
