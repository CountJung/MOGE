@using MudBlazor

<MudStack Spacing="2">
    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
        <MudTooltip Text="Perspective Mode">
            <MudIconButton Icon="@Icons.Material.Filled.Tune"
                           Color="@(PerspectiveMode ? Color.Primary : Color.Inherit)"
                           Style="@ToggleIconStyle(PerspectiveMode)"
                           OnClick="TogglePerspectiveMode"
                           aria-label="Toggle Perspective Mode" />
        </MudTooltip>

        <MudTooltip Text="Crop Mode">
            <MudIconButton Icon="@Icons.Material.Filled.CropSquare"
                           Color="@(CropMode ? Color.Primary : Color.Inherit)"
                           Disabled="@PerspectiveMode"
                           Style="@ToggleIconStyle(CropMode)"
                           OnClick="ToggleCropMode"
                           aria-label="Toggle Crop Mode" />
        </MudTooltip>
    </MudStack>

    @if (PerspectiveMode)
    {
        <MudText Typo="Typo.caption">Drag the 4 points on the canvas, then apply.</MudText>
        <MudTooltip Text="Apply Perspective">
            <MudIconButton Icon="@Icons.Material.Filled.Check"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Disabled="@(!HasImage)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await ApplyPerspective.InvokeAsync())"
                           aria-label="Apply Perspective" />
        </MudTooltip>
    }

    @if (CropMode)
    {
        <MudText Typo="Typo.caption">Drag the 4 corners, then apply crop.</MudText>
        <MudTooltip Text="Apply Crop">
            <MudIconButton Icon="@Icons.Material.Filled.Check"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Disabled="@(!HasImage)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await ApplyCrop.InvokeAsync())"
                           aria-label="Apply Crop" />
        </MudTooltip>
    }

    <MudText Typo="Typo.subtitle2">Transform</MudText>
    <MudStack Row="true" Spacing="1">
        <MudTooltip Text="Rotate Left">
            <MudIconButton Icon="@Icons.Material.Filled.RotateLeft"
                           Disabled="@(!HasImage)"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await RotateLeft.InvokeAsync())"
                           aria-label="Rotate Left" />
        </MudTooltip>
        <MudTooltip Text="Rotate Right">
            <MudIconButton Icon="@Icons.Material.Filled.RotateRight"
                           Disabled="@(!HasImage)"
                           Color="@(HasImage ? Color.Primary : Color.Inherit)"
                           Style="@ActionIconStyle(HasImage)"
                           OnClick="@(async () => await RotateRight.InvokeAsync())"
                           aria-label="Rotate Right" />
        </MudTooltip>
    </MudStack>
    <MudTooltip Text="Resize 50%">
        <MudIconButton Icon="@Icons.Material.Filled.PhotoSizeSelectSmall"
                       Disabled="@(!HasImage)"
                       Color="@(HasImage ? Color.Primary : Color.Inherit)"
                       Style="@ActionIconStyle(HasImage)"
                       OnClick="@(async () => await ResizeHalf.InvokeAsync())"
                       aria-label="Resize 50%" />
    </MudTooltip>

    <MudDivider />
    <MudText Typo="Typo.subtitle2">Filters</MudText>

    <MudText Typo="Typo.caption">Blur Kernel</MudText>
    <MudSlider T="int" Value="@BlurKernelSize" ValueChanged="BlurKernelSizeChanged" Min="0" Max="31" Step="1" Color="Color.Primary" />

    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
        <MudTooltip Text="Grayscale">
            <MudIconButton Icon="@Icons.Material.Filled.MonochromePhotos"
                           Color="@(Grayscale ? Color.Primary : Color.Inherit)"
                           Disabled="@Sepia"
                           Style="@ToggleIconStyle(Grayscale && !Sepia)"
                           OnClick="ToggleGrayscale"
                           aria-label="Toggle Grayscale" />
        </MudTooltip>
        <MudTooltip Text="Sepia">
            <MudIconButton Icon="@Icons.Material.Filled.FilterVintage"
                           Color="@(Sepia ? Color.Primary : Color.Inherit)"
                           Style="@ToggleIconStyle(Sepia)"
                           OnClick="ToggleSepia"
                           aria-label="Toggle Sepia" />
        </MudTooltip>
        <MudTooltip Text="Canny Edge">
            <MudIconButton Icon="@Icons.Material.Filled.Timeline"
                           Color="@(Canny ? Color.Primary : Color.Inherit)"
                           Style="@ToggleIconStyle(Canny)"
                           OnClick="ToggleCanny"
                           aria-label="Toggle Canny Edge" />
        </MudTooltip>
    </MudStack>

    @if (Canny)
    {
        <MudText Typo="Typo.caption">Canny T1</MudText>
        <MudSlider T="double" Value="@CannyT1" ValueChanged="CannyT1Changed" Min="0" Max="255" Step="1" Color="Color.Primary" />
        <MudText Typo="Typo.caption">Canny T2</MudText>
        <MudSlider T="double" Value="@CannyT2" ValueChanged="CannyT2Changed" Min="0" Max="255" Step="1" Color="Color.Primary" />
    }

    <MudText Typo="Typo.caption">Contrast</MudText>
    <MudSlider T="double" Value="@Contrast" ValueChanged="ContrastChanged" Min="0.5" Max="3.0" Step="0.05" Color="Color.Primary" />
    <MudText Typo="Typo.caption">Brightness</MudText>
    <MudSlider T="double" Value="@Brightness" ValueChanged="BrightnessChanged" Min="-100" Max="100" Step="1" Color="Color.Primary" />

    <MudDivider />
    <MudText Typo="Typo.subtitle2">History</MudText>
    <MudStack Row="true" Spacing="1">
        <MudTooltip Text="Undo">
            <MudIconButton Icon="@Icons.Material.Filled.Undo"
                           Disabled="@(!CanUndo)"
                           OnClick="@(async () => await Undo.InvokeAsync())"
                           aria-label="Undo" />
        </MudTooltip>
        <MudTooltip Text="Redo">
            <MudIconButton Icon="@Icons.Material.Filled.Redo"
                           Disabled="@(!CanRedo)"
                           OnClick="@(async () => await Redo.InvokeAsync())"
                           aria-label="Redo" />
        </MudTooltip>
        <MudTooltip Text="Reset">
            <MudIconButton Icon="@Icons.Material.Filled.Restore"
                           Disabled="@(!CanUndo)"
                           OnClick="@(async () => await Reset.InvokeAsync())"
                           aria-label="Reset" />
        </MudTooltip>
    </MudStack>

    <MudList T="string" Dense="true">
        @if (HistoryItems is not null)
        {
            @foreach (var item in HistoryItems)
            {
                var idx = item.Index;
                var isCurrent = idx == CurrentHistoryIndex;
                <MudListItem T="string" Value="@item.DisplayLabel" OnClick="@(async () => await OnHistoryItemClicked(idx))" Disabled="@(!HasImage)" Style="@HistoryItemStyle(isCurrent)">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        @if (isCurrent)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" Size="Size.Small" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Inherit" Size="Size.Small" Style="opacity:0.25;" />
                        }

                        @if (!string.IsNullOrWhiteSpace(item.ThumbnailDataUrl))
                        {
                            <img src="@item.ThumbnailDataUrl" width="40" height="40" style="object-fit:contain" />
                        }
                        <MudText Typo="Typo.caption" Style="@(isCurrent ? "font-weight:600;" : null)">@item.DisplayLabel</MudText>
                    </MudStack>
                </MudListItem>
            }
        }
    </MudList>

</MudStack>

@code {
    [Parameter] public bool HasImage { get; set; }

    [Parameter] public bool PerspectiveMode { get; set; }
    [Parameter] public EventCallback<bool> PerspectiveModeChanged { get; set; }

    [Parameter] public bool CropMode { get; set; }
    [Parameter] public EventCallback<bool> CropModeChanged { get; set; }

    [Parameter] public EventCallback ApplyCrop { get; set; }

    [Parameter] public EventCallback ApplyPerspective { get; set; }

    [Parameter] public EventCallback RotateLeft { get; set; }
    [Parameter] public EventCallback RotateRight { get; set; }
    [Parameter] public EventCallback ResizeHalf { get; set; }

    [Parameter] public int BlurKernelSize { get; set; }
    [Parameter] public EventCallback<int> BlurKernelSizeChanged { get; set; }

    [Parameter] public bool Grayscale { get; set; }
    [Parameter] public EventCallback<bool> GrayscaleChanged { get; set; }

    [Parameter] public bool Sepia { get; set; }
    [Parameter] public EventCallback<bool> SepiaChanged { get; set; }

    [Parameter] public bool Canny { get; set; }
    [Parameter] public EventCallback<bool> CannyChanged { get; set; }

    [Parameter] public double CannyT1 { get; set; }
    [Parameter] public EventCallback<double> CannyT1Changed { get; set; }

    [Parameter] public double CannyT2 { get; set; }
    [Parameter] public EventCallback<double> CannyT2Changed { get; set; }

    [Parameter] public double Contrast { get; set; }
    [Parameter] public EventCallback<double> ContrastChanged { get; set; }

    [Parameter] public double Brightness { get; set; }
    [Parameter] public EventCallback<double> BrightnessChanged { get; set; }

    [Parameter] public bool CanUndo { get; set; }
    [Parameter] public bool CanRedo { get; set; }

    [Parameter] public int CurrentHistoryIndex { get; set; } = -1;

    [Parameter] public EventCallback Undo { get; set; }
    [Parameter] public EventCallback Redo { get; set; }
    [Parameter] public EventCallback Reset { get; set; }

    [Parameter] public IReadOnlyList<EditorHistoryListItem>? HistoryItems { get; set; }
    [Parameter] public EventCallback<int> HistoryItemSelected { get; set; }

    private static string ToggleIconStyle(bool isActive)
    {
        var borderColor = isActive ? "var(--mud-palette-primary)" : "var(--mud-palette-lines-default)";
        return $"border:1px solid {borderColor}; border-radius: var(--mud-default-borderradius);";
    }

    private static string ActionIconStyle(bool isEnabled)
    {
        var borderColor = isEnabled ? "var(--mud-palette-primary)" : "var(--mud-palette-lines-default)";
        return $"border:1px solid {borderColor}; border-radius: var(--mud-default-borderradius);";
    }

    private static string HistoryItemStyle(bool isCurrent)
    {
        if (!isCurrent)
            return "border-left:3px solid transparent;";

        return "border-left:3px solid var(--mud-palette-primary);";
    }

    private Task OnHistoryItemClicked(int index)
    {
        if (!HasImage)
            return Task.CompletedTask;

        if (index == CurrentHistoryIndex)
            return Task.CompletedTask;

        return HistoryItemSelected.InvokeAsync(index);
    }

    private Task TogglePerspectiveMode()
    {
        return PerspectiveModeChanged.InvokeAsync(!PerspectiveMode);
    }

    private Task ToggleCropMode()
    {
        if (PerspectiveMode)
        {
            return Task.CompletedTask;
        }

        return CropModeChanged.InvokeAsync(!CropMode);
    }

    private Task ToggleGrayscale()
    {
        if (Sepia)
        {
            return Task.CompletedTask;
        }

        return GrayscaleChanged.InvokeAsync(!Grayscale);
    }

    private Task ToggleSepia()
    {
        return SepiaChanged.InvokeAsync(!Sepia);
    }

    private Task ToggleCanny()
    {
        return CannyChanged.InvokeAsync(!Canny);
    }

}
