@page "/"

@inherits SharedUI.Mvvm.ViewModelComponentBase<SharedUI.ViewModels.EditorViewModel>

@using OpenCvSharp
@using System.IO
@using SharedUI.Components

@inject IImageFilePicker ImageFilePicker
@inject ImageDocumentState Document
@inject ImageProcessorService ImageProcessor
@inject IImageExportService ImageExport

<MudGrid Class="pa-4" Spacing="2" Style="margin-bottom: var(--moge-footer-height, 96px);">
    <MudItem xs="12">
        <EditorHeader HasImage="@Vm!.HasImage"
                      FileName="@Vm!.FileName"
                      FileSizeBytes="@Vm!.FileSizeBytes"
                      OpenImage="Vm!.PickImagesAsync"
                      SavePng="Vm!.SavePngAsync"
                      Clear="Vm!.ClearAsync" />
    </MudItem>

    <MudItem xs="12">
        @if (Vm!.LoadedImages.Count > 0)
        {
            <MudPaper Class="pa-2" Outlined="true" Style="overflow-x:auto;">
                <MudStack Row="true" Spacing="2" Style="flex-wrap:nowrap;">
                    @foreach (var item in Vm!.LoadedImages)
                    {
                        var idx = item.Index;
                        var isSelected = idx == Vm!.SelectedLoadedIndex;

                        <MudPaper Class="pa-2" Elevation="0" Style="@SharedUI.ViewModels.EditorViewModel.GetLoadedImageCardStyle(isSelected)" @onclick="(() => Vm!.SelectLoadedImage(idx))">
                            @if (!string.IsNullOrWhiteSpace(item.ThumbnailDataUrl))
                            {
                                <MudImage Src="@item.ThumbnailDataUrl" Width="120" Height="120" Style="object-fit:contain;" />
                            }
                            else
                            {
                                <MudText Typo="Typo.caption">(no preview)</MudText>
                            }

                            <MudText Typo="Typo.caption" Style="max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">@item.FileName</MudText>
                        </MudPaper>
                    }
                </MudStack>
            </MudPaper>
        }
    </MudItem>

    <MudItem xs="12" md="3" lg="2">
        <EditorToolBar HasImage="@Vm!.HasImage"
                       PerspectiveMode="@Vm!.PerspectiveMode"
                       CropMode="@Vm!.CropMode"
                       InteractionMode="@Vm!.InteractionMode"
                       InteractionModeChanged="Vm!.OnInteractionModeChanged"
                       BrushRadius="@Vm!.BrushRadius"
                       BrushRadiusChanged="Vm!.OnBrushRadiusChanged"
                       SelectionMode="@Vm!.SelectionMode"
                       SelectionModeChanged="Vm!.OnSelectionModeChanged"
                       SelectionBlurKernelSize="@Vm!.SelectionBlurKernelSize"
                       SelectionBlurKernelSizeChanged="Vm!.OnSelectionBlurKernelSizeChanged"
                       SharpenAmount="@Vm!.SelectionSharpenAmount"
                       SharpenAmountChanged="Vm!.OnSelectionSharpenAmountChanged"
                       ApplySelectionBlur="Vm!.ApplySelectionBlurAsync"
                       ApplySelectionSharpen="Vm!.ApplySelectionSharpenAsync" />
    </MudItem>

    <MudItem xs="12" md="7" lg="8">
        <ImageCanvas ImageBytes="@Vm!.ViewBytes" ContentType="@Vm!.ContentType"
                    EnableHandles="@(Vm!.PerspectiveMode || Vm!.CropMode || Vm!.SelectionMode)"
                    HandlesAsRectangle="@(Vm!.CropMode || Vm!.SelectionMode)"
                    Handles="@Vm!.Handles"
                    HandlesChanged="Vm!.OnHandlesChanged"
                    InteractionMode="@((Vm!.PerspectiveMode || Vm!.CropMode || Vm!.SelectionMode) ? CanvasInteractionMode.PanZoom : Vm!.InteractionMode)"
                    BrushRadius="@Vm!.BrushRadius"
                    CanvasReady="Vm!.OnCanvasReady"
                    StrokeCommitted="Vm!.OnStrokeCommittedAsync" />
    </MudItem>

    <MudItem xs="12" md="2" lg="2">
        <MudPaper Elevation="1" Class="pa-2" Style="height: clamp(240px, 70vh, 720px); overflow:auto;">
            <EditorRightPanel
                HasImage="@Vm!.HasImage"
                PerspectiveMode="@Vm!.PerspectiveMode"
                PerspectiveModeChanged="Vm!.OnPerspectiveModeChanged"
                ApplyPerspective="Vm!.ApplyPerspectiveAsync"
                CropMode="@Vm!.CropMode"
                CropModeChanged="Vm!.OnCropModeChanged"
                ApplyCrop="Vm!.ApplyCropAsync"
                RotateLeft="Vm!.RotateLeftAsync"
                RotateRight="Vm!.RotateRightAsync"
                ResizeHalf="Vm!.ResizeHalfAsync"
                BlurKernelSize="@Vm!.BlurKernelSize"
                BlurKernelSizeChanged="Vm!.OnBlurChanged"
                Grayscale="@Vm!.Grayscale"
                GrayscaleChanged="Vm!.OnGrayscaleChanged"
                Sepia="@Vm!.Sepia"
                SepiaChanged="Vm!.OnSepiaChanged"
                Canny="@Vm!.Canny"
                CannyChanged="Vm!.OnCannyChanged"
                CannyT1="@Vm!.CannyT1"
                CannyT1Changed="Vm!.OnCannyT1Changed"
                CannyT2="@Vm!.CannyT2"
                CannyT2Changed="Vm!.OnCannyT2Changed"
                Contrast="@Vm!.Contrast"
                ContrastChanged="Vm!.OnContrastChanged"
                Brightness="@Vm!.Brightness"
                BrightnessChanged="Vm!.OnBrightnessChanged"
                CanUndo="@Vm!.CanUndo"
                CanRedo="@Vm!.CanRedo"
                CurrentHistoryIndex="@Vm!.CurrentHistoryIndex"
                Undo="Vm!.UndoAsync"
                Redo="Vm!.RedoAsync"
                Reset="Vm!.ResetToOriginalAsync"
                HistoryItems="@Vm!.HistoryItems"
                HistoryItemSelected="Vm!.GoToHistoryAsync" />
        </MudPaper>
    </MudItem>
</MudGrid>
