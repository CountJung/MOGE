@page "/"

@inherits SharedUI.Mvvm.ViewModelComponentBase<SharedUI.ViewModels.EditorViewModel>

@using OpenCvSharp
@using System.IO
@using SharedUI.Components

@inject IImageFilePicker ImageFilePicker
@inject ImageDocumentState Document
@inject ImageProcessorService ImageProcessor
@inject IImageExportService ImageExport
@inject MudBlazor.IDialogService DialogService

<MudGrid Class="pa-4" Spacing="2" Style="margin-bottom: var(--moge-footer-height, 96px);">
    <MudItem xs="12">
        <EditorHeader HasImage="@Vm!.HasImage"
                      FileName="@Vm!.FileName"
                      FileSizeBytes="@Vm!.FileSizeBytes"
                      New="OnNewClickedAsync"
                      OpenImage="Vm!.PickImagesAsync"
                      SavePng="OnSaveClickedAsync"
                      LoadedImages="@Vm!.LoadedImageNames"
                      SelectedLoadedIndex="@Vm!.SelectedLoadedIndex"
                      SelectLoadedIndex="Vm!.SelectLoadedImage"
                      RemoveLoaded="Vm!.RemoveSelectedLoadedImageAsync" />
    </MudItem>

    <MudItem xs="12" md="3" lg="2">
        <EditorToolBar HasImage="@Vm!.HasImage"
                       PerspectiveMode="@Vm!.PerspectiveMode"
                       CropMode="@Vm!.CropMode"
                       InteractionMode="@Vm!.InteractionMode"
                       InteractionModeChanged="Vm!.OnInteractionModeChanged"
                       BrushRadius="@Vm!.BrushRadius"
                       BrushRadiusChanged="Vm!.OnBrushRadiusChanged"
                       MagicWandTolerance="@Vm!.MagicWandTolerance"
                       MagicWandToleranceChanged="Vm!.OnMagicWandToleranceChanged"
                       ForegroundColorHex="@Vm!.ForegroundColorHex"
                       ForegroundColorHexChanged="Vm!.OnForegroundColorHexChanged"
                       ForegroundAlpha="@Vm!.ForegroundAlpha"
                       ForegroundAlphaChanged="Vm!.OnForegroundAlphaChanged"
                       BackgroundColorHex="@Vm!.BackgroundColorHex"
                       BackgroundColorHexChanged="Vm!.OnBackgroundColorHexChanged"
                       BackgroundAlpha="@Vm!.BackgroundAlpha"
                       BackgroundAlphaChanged="Vm!.OnBackgroundAlphaChanged"
                       SelectionMode="@Vm!.SelectionMode"
                       SelectionModeChanged="Vm!.OnSelectionModeChanged"
                       SelectionBlurKernelSize="@Vm!.SelectionBlurKernelSize"
                       SelectionBlurKernelSizeChanged="Vm!.OnSelectionBlurKernelSizeChanged"
                       SharpenAmount="@Vm!.SelectionSharpenAmount"
                       SharpenAmountChanged="Vm!.OnSelectionSharpenAmountChanged"
                       ApplySelectionBlur="Vm!.ApplySelectionBlurAsync"
                       ApplySelectionSharpen="Vm!.ApplySelectionSharpenAsync"
                       FillSelection="Vm!.FillSelectionAsync"
                       CanFillSelection="@Vm!.CanFillSelection" />
    </MudItem>

    <MudItem xs="12" md="7" lg="8">
        <ImageCanvas ImageBytes="@Vm!.ViewBytes" ContentType="@Vm!.ContentType"
                    EnableHandles="@(Vm!.PerspectiveMode || Vm!.CropMode || Vm!.SelectionMode)"
                    HandlesAsRectangle="@(Vm!.CropMode || Vm!.SelectionMode)"
                    Handles="@Vm!.Handles"
                    HandlesChanged="Vm!.OnHandlesChanged"
                    ShowOverlayPolygon="@Vm!.HasSelectionPreviewPolygon"
                    OverlayPolygonDashed="true"
                    OverlayPolygonPoints="@Vm!.SelectionPreviewPolygonPoints"
                    InteractionMode="@((Vm!.PerspectiveMode || Vm!.CropMode || Vm!.SelectionMode) ? CanvasInteractionMode.PanZoom : Vm!.InteractionMode)"
                    BrushRadius="@Vm!.BrushRadius"
                    CanvasReady="Vm!.OnCanvasReady"
                    StrokeCommitted="Vm!.OnStrokeCommittedAsync"
                    CanvasClicked="Vm!.OnCanvasClickedAsync" />

                <MudOverlay Visible="@Vm!.IsProcessing"
                        DarkBackground="true"
                        AutoClose="false"
                        Class="d-flex justify-center align-center"
                        Style="z-index: 2000;">
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="MudBlazor.Size.Large" />
                </MudOverlay>
    </MudItem>

    <MudItem xs="12" md="2" lg="2">
        <MudPaper Elevation="1" Class="pa-2" Style="height: clamp(240px, 65vh, 680px); overflow:auto;">
            <EditorRightPanel
                HasImage="@Vm!.HasImage"
                Layers="@Vm!.Layers"
                ActiveLayerIndex="@Vm!.ActiveLayerIndex"
                CanDeleteLayer="@Vm!.CanDeleteLayer"
                CanMergeDown="@Vm!.CanMergeDown"
                CanToggleLayerVisibility="@Vm!.CanToggleLayerVisibility"
                LayerSelected="Vm!.SelectLayer"
                ToggleLayerVisibility="Vm!.ToggleLayerVisibilityAsync"
                AddLayer="Vm!.AddLayerAsync"
                DuplicateLayer="Vm!.DuplicateLayerAsync"
                DeleteLayer="Vm!.DeleteLayerAsync"
                MergeDownLayer="Vm!.MergeDownActiveLayerAsync"
                PerspectiveMode="@Vm!.PerspectiveMode"
                PerspectiveModeChanged="Vm!.OnPerspectiveModeChanged"
                ApplyPerspective="Vm!.ApplyPerspectiveAsync"
                CropMode="@Vm!.CropMode"
                CropModeChanged="Vm!.OnCropModeChanged"
                ApplyCrop="Vm!.ApplyCropAsync"
                RotateLeft="Vm!.RotateLeftAsync"
                RotateRight="Vm!.RotateRightAsync"
                ResizeHalf="Vm!.ResizeHalfAsync"
                BlurKernelSize="@Vm!.BlurKernelSize"
                BlurKernelSizeChanged="Vm!.OnBlurChanged"
                Grayscale="@Vm!.Grayscale"
                GrayscaleChanged="Vm!.OnGrayscaleChanged"
                Sepia="@Vm!.Sepia"
                SepiaChanged="Vm!.OnSepiaChanged"
                Invert="@Vm!.Invert"
                InvertChanged="Vm!.OnInvertChanged"
                Saturation="@Vm!.Saturation"
                SaturationChanged="Vm!.OnSaturationChanged"
                Sketch="@Vm!.Sketch"
                SketchChanged="Vm!.OnSketchChanged"
                Cartoon="@Vm!.Cartoon"
                CartoonChanged="Vm!.OnCartoonChanged"
                Emboss="@Vm!.Emboss"
                EmbossChanged="Vm!.OnEmbossChanged"
                FilterSharpenAmount="@Vm!.FilterSharpenAmount"
                FilterSharpenAmountChanged="Vm!.OnFilterSharpenAmountChanged"
                GlowStrength="@Vm!.GlowStrength"
                GlowStrengthChanged="Vm!.OnGlowStrengthChanged"
                ColorMap="@Vm!.ColorMap"
                ColorMapChanged="Vm!.OnColorMapChanged"
                ColorMapStrength="@Vm!.ColorMapStrength"
                ColorMapStrengthChanged="Vm!.OnColorMapStrengthChanged"
                PosterizeLevels="@Vm!.PosterizeLevels"
                PosterizeLevelsChanged="Vm!.OnPosterizeLevelsChanged"
                PixelizeBlockSize="@Vm!.PixelizeBlockSize"
                PixelizeBlockSizeChanged="Vm!.OnPixelizeBlockSizeChanged"
                VignetteStrength="@Vm!.VignetteStrength"
                VignetteStrengthChanged="Vm!.OnVignetteStrengthChanged"
                NoiseAmount="@Vm!.NoiseAmount"
                NoiseAmountChanged="Vm!.OnNoiseAmountChanged"
                Canny="@Vm!.Canny"
                CannyChanged="Vm!.OnCannyChanged"
                CannyT1="@Vm!.CannyT1"
                CannyT1Changed="Vm!.OnCannyT1Changed"
                CannyT2="@Vm!.CannyT2"
                CannyT2Changed="Vm!.OnCannyT2Changed"
                Contrast="@Vm!.Contrast"
                ContrastChanged="Vm!.OnContrastChanged"
                Brightness="@Vm!.Brightness"
                BrightnessChanged="Vm!.OnBrightnessChanged"
                CanUndo="@Vm!.CanUndo"
                CanRedo="@Vm!.CanRedo"
                CurrentHistoryIndex="@Vm!.CurrentHistoryIndex"
                Undo="Vm!.UndoAsync"
                Redo="Vm!.RedoAsync"
                Reset="Vm!.ResetToOriginalAsync"
                HistoryItems="@Vm!.HistoryItems"
                HistoryItemSelected="Vm!.GoToHistoryAsync" />
        </MudPaper>
    </MudItem>
</MudGrid>
