@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using SharedUI.Services.Raw
@using SharedUI.Services.Settings

<MudPaper Elevation="1" Class="pa-2" Style="height: clamp(320px, 65vh, 680px);">
    <div style="position:relative; width:100%; height:100%;">
        <canvas @ref="_canvas" draggable="false" style="width:100%; height:100%; touch-action:none; display:block; user-select:none; -webkit-user-select:none; -webkit-user-drag:none; cursor:@GetCanvasCursorCss();"
            @onwheel="OnWheel" @onwheel:preventDefault="true" @onwheel:stopPropagation="true"
            @onpointerdown="OnPointerDown" @onpointerdown:preventDefault="true"
            @onpointermove="OnPointerMove" @onpointermove:preventDefault="true"
            @onpointerup="OnPointerUp" @onpointerup:preventDefault="true"
            @onpointerleave="OnPointerUp">
        </canvas>

        @if (ShowOverlayPolygon && OverlayPolygonPoints is { Count: > 2 })
        {
            var pts = new System.Text.StringBuilder(capacity: OverlayPolygonPoints.Count * 16);
            for (var i = 0; i < OverlayPolygonPoints.Count; i++)
            {
                var p = OverlayPolygonPoints[i];
                var sx = _offsetX + (p.X * _scale);
                var sy = _offsetY + (p.Y * _scale);
                if (i > 0)
                    pts.Append(' ');
                pts.Append(sx.ToString("0.###", System.Globalization.CultureInfo.InvariantCulture));
                pts.Append(',');
                pts.Append(sy.ToString("0.###", System.Globalization.CultureInfo.InvariantCulture));
            }

            var dash = OverlayPolygonDashed ? "6 4" : null;

            <svg style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none; overflow:visible;">
                <polygon points="@pts.ToString()" fill="none" stroke="var(--mud-palette-primary)" stroke-width="2" stroke-dasharray="@dash" />
            </svg>
        }

        @if (ShowOverlayRectangle && OverlayHandles is { Count: >= 2 })
        {
            var minX = OverlayHandles.Min(p => p.X);
            var maxX = OverlayHandles.Max(p => p.X);
            var minY = OverlayHandles.Min(p => p.Y);
            var maxY = OverlayHandles.Max(p => p.Y);

            var rectLeft = _offsetX + (minX * _scale);
            var rectTop = _offsetY + (minY * _scale);
            var rectWidth = (maxX - minX) * _scale;
            var rectHeight = (maxY - minY) * _scale;

            var border = OverlayDashed
                ? "2px dashed var(--mud-palette-primary)"
                : "2px solid var(--mud-palette-primary)";

            <div style="position:absolute; left:@(rectLeft)px; top:@(rectTop)px; width:@(rectWidth)px; height:@(rectHeight)px; box-sizing:border-box; border:@border; pointer-events:none;"></div>
        }

        @* Live lasso drawing preview *@
        @if (_drawing && InteractionMode == CanvasInteractionMode.LassoSelection && _strokePoints.Count > 1)
        {
            var lassoPath = new System.Text.StringBuilder(capacity: _strokePoints.Count * 16);
            for (var i = 0; i < _strokePoints.Count; i++)
            {
                var p = _strokePoints[i];
                var sx = _offsetX + (p.X * _scale);
                var sy = _offsetY + (p.Y * _scale);
                if (i > 0)
                    lassoPath.Append(' ');
                lassoPath.Append(sx.ToString("0.###", System.Globalization.CultureInfo.InvariantCulture));
                lassoPath.Append(',');
                lassoPath.Append(sy.ToString("0.###", System.Globalization.CultureInfo.InvariantCulture));
            }

            <svg style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none; overflow:visible;">
                <polyline points="@lassoPath.ToString()" fill="none" stroke="var(--mud-palette-secondary)" stroke-width="2" stroke-dasharray="4 2" />
            </svg>
        }

        @if (EnableHandles && Handles is { Count: > 0 })
        {
            @if (HandlesAsRectangle && Handles.Count >= 2)
            {
                var minX = Handles.Min(p => p.X);
                var maxX = Handles.Max(p => p.X);
                var minY = Handles.Min(p => p.Y);
                var maxY = Handles.Max(p => p.Y);

                var rectLeft = _offsetX + (minX * _scale);
                var rectTop = _offsetY + (minY * _scale);
                var rectWidth = (maxX - minX) * _scale;
                var rectHeight = (maxY - minY) * _scale;

                // Visual crop rectangle overlay. Uses MudBlazor theme CSS variables (no hard-coded colors).
                <div style="position:absolute; left:@(rectLeft)px; top:@(rectTop)px; width:@(rectWidth)px; height:@(rectHeight)px; box-sizing:border-box; border:2px solid var(--mud-palette-primary); pointer-events:none;"></div>
            }

            @for (var i = 0; i < Handles.Count; i++)
            {
                var handleIndex = i;
                var p = Handles[i];
                var screenX = _offsetX + (p.X * _scale);
                var screenY = _offsetY + (p.Y * _scale);

                var isRect = HandlesAsRectangle;
                var size = isRect ? 14 : 16;
                var half = size / 2.0;
                var borderRadius = isRect ? "2px" : "50%";
                var border = isRect ? "2px solid var(--mud-palette-surface)" : "0";

                 <div draggable="false" style="position:absolute; left:@(screenX - half)px; top:@(screenY - half)px; width:@(size)px; height:@(size)px; border-radius:@(borderRadius); background: var(--mud-palette-primary); border:@(border); touch-action:none; user-select:none; -webkit-user-select:none; -webkit-user-drag:none; cursor:move;"
                     @onpointerdown="(e) => OnHandlePointerDown(handleIndex, e)" @onpointerdown:preventDefault="true" @onpointerdown:stopPropagation="true"
                     @onpointermove="MoveHandleAsync" @onpointermove:preventDefault="true" @onpointermove:stopPropagation="true"
                     @onpointerup="OnPointerUp" @onpointerup:preventDefault="true" @onpointerup:stopPropagation="true"
                     @onpointerleave="OnPointerUp">
                </div>
            }
        }
    </div>
</MudPaper>

